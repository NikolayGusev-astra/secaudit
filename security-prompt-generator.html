<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SEC_PROMPT_GENERATOR // STACK-AWARE EDITION</title>
    <style>
        :root {
            --bg: #0d1117;
            --panel: #161b22;
            --border: #30363d;
            --text: #c9d1d9;
            --accent: #58a6ff;
            --green: #2ea043;
            --red: #da3633;
            --font-mono: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
        }
        body {
            background: var(--bg);
            color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 10px;
        }
        h1 { font-size: 1.2rem; margin: 0; color: var(--accent); }
        .container {
            display: flex;
            gap: 20px;
            flex: 1;
            overflow: hidden;
        }
        .panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 6px;
            overflow: hidden;
        }
        .panel-header {
            padding: 10px 15px;
            background: #21262d;
            border-bottom: 1px solid var(--border);
            font-size: 0.9rem;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        textarea {
            flex: 1;
            background: var(--bg);
            border: none;
            color: var(--text);
            padding: 15px;
            font-family: var(--font-mono);
            font-size: 0.85rem;
            resize: none;
            outline: none;
        }
        .results-area {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            font-family: var(--font-mono);
        }
        .prompt-card {
            background: var(--bg);
            border: 1px solid var(--border);
            border-left: 3px solid var(--accent);
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 4px;
        }
        .prompt-card.high { border-left-color: var(--red); }
        .prompt-card.med { border-left-color: var(--green); }

        .card-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.8rem;
            color: #8b949e;
        }
        .prompt-content {
            font-size: 0.85rem;
            color: #e6edf3;
            margin-bottom: 10px;
            white-space: pre-wrap;
        }
        .btn {
            background: #238636;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: bold;
        }
        .btn:hover { background: #2ea043; }
        .btn-main { padding: 8px 16px; font-size: 0.9rem; }
        .badge {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
            background: #30363d;
        }
        .badge-high { background: rgba(218, 54, 51, 0.2); color: #f85149; border: 1px solid #da3633; }
        .badge-med { background: rgba(46, 160, 67, 0.2); color: #3fb950; border: 1px solid #2ea043; }

        .stack-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding: 10px;
            background: var(--bg);
            border-radius: 4px;
        }
        select {
            background: var(--panel);
            color: var(--text);
            border: 1px solid var(--border);
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        select:focus { outline: 1px solid var(--accent); }
    </style>
</head>
<body>

    <header>
        <h1>SEC_PROMPT_GENERATOR // STACK-AWARE EDITION</h1>
        <button class="btn btn-main" onclick="generatePrompts()">GENERATE AI PROMPTS</button>
    </header>

    <div class="container">
        <!-- INPUT PANEL -->
        <div class="panel">
            <div class="panel-header">
                <span>INPUT: RAW REPORT (MARKDOWN)</span>
                <button class="btn" onclick="clearInput()">CLEAR</button>
            </div>
            <div class="stack-selector">
                <label for="techStack">Tech Stack:</label>
                <select id="techStack">
                    <option value="nextjs-vercel">Next.js / Vercel / React</option>
                    <option value="php-laravel">PHP / Laravel / Apache</option>
                    <option value="python-django">Python / Django / Flask</option>
                    <option value="java-spring">Java / Spring Boot / Tomcat</option>
                    <option value="static-nginx">Static HTML / Nginx</option>
                </select>
            </div>
            <textarea id="inputReport" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ –≤–∞—à Markdown –æ—Ç—á–µ—Ç..."></textarea>
        </div>

        <!-- OUTPUT PANEL -->
        <div class="panel">
            <div class="panel-header">
                <span>OUTPUT: AI PROMPTS</span>
                <span id="stats" style="font-weight:normal; color:#8b949e;">0 prompts</span>
            </div>
            <div class="results-area" id="outputArea">
                <div style="text-align: center; color: #484f58; margin-top: 50px;">
                    Waiting for input data...
                </div>
            </div>
        </div>
    </div>

    <script>
        // SNIPPET DATABASE - Code Scaffolding for Fixes
        const SNIPPET_DATABASE = {
            'Content-Security-Policy': {
                'nextjs-vercel': {
                    file: 'next.config.js',
                    language: 'javascript',
                    code: `// next.config.js
module.exports = {
  // ... other config
  headers: async () => [
    {
      source: '/(.*)',
      headers: [
        {
          key: 'Content-Security-Policy',
          value: "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:;"
        }
      ]
    }
  ]
}`
                },
                'php-laravel': {
                    file: '.htaccess',
                    language: 'apache',
                    code: `# .htaccess
<IfModule mod_headers.c>
  Header set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'"
</IfModule>`
                },
                'python-django': {
                    file: 'settings.py',
                    language: 'python',
                    code: `# settings.py
# Install django-csp first: pip install django-csp

INSTALLED_APPS = [
    # ... other apps
    'csp',
]

MIDDLEWARE = [
    # ... other middleware
    'csp.middleware.CSPMiddleware',
]

# CSP Settings
CSP_DEFAULT_SRC = ("'self'",)
CSP_SCRIPT_SRC = ("'self'", "'unsafe-inline'")
CSP_STYLE_SRC = ("'self'", "'unsafe-inline'")
CSP_IMG_SRC = ("'self'", "data:", "https:")
CSP_FONT_SRC = ("'self'", "data:")`
                },
                'java-spring': {
                    file: 'WebSecurityConfig.java',
                    language: 'java',
                    code: `// WebSecurityConfig.java
@Configuration
@EnableWebSecurity
public class WebSecurityConfig extends WebSecurityConfigurerAdapter {

    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http
            .headers(headers ->
                headers
                    .contentSecurityPolicy("default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'")
            );
    }
}`
                },
                'static-nginx': {
                    file: 'nginx.conf',
                    language: 'nginx',
                    code: `# nginx.conf
server {
    # ... other config
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'" always;
}`
                }
            },

            'X-Frame-Options': {
                'nextjs-vercel': {
                    file: 'next.config.js',
                    language: 'javascript',
                    code: `// next.config.js
module.exports = {
  headers: async () => [
    {
      source: '/(.*)',
      headers: [
        {
          key: 'X-Frame-Options',
          value: 'DENY'
        }
      ]
    }
  ]
}`
                },
                'php-laravel': {
                    file: '.htaccess',
                    language: 'apache',
                    code: `# .htaccess
<IfModule mod_headers.c>
  Header always set X-Frame-Options "DENY"
</IfModule>`
                },
                'python-django': {
                    file: 'settings.py',
                    language: 'python',
                    code: `# settings.py
# Security settings
SECURE_FRAME_DENY = True`
                },
                'java-spring': {
                    file: 'WebSecurityConfig.java',
                    language: 'java',
                    code: `// WebSecurityConfig.java
@Configuration
@EnableWebSecurity
public class WebSecurityConfig extends WebSecurityConfigurerAdapter {

    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http
            .headers(headers ->
                headers.frameOptions().deny()
            );
    }
}`
                },
                'static-nginx': {
                    file: 'nginx.conf',
                    language: 'nginx',
                    code: `# nginx.conf
server {
    add_header X-Frame-Options "DENY" always;
}`
                }
            },

            'Inline Event Handlers': {
                'nextjs-vercel': {
                    file: 'Component.tsx',
                    language: 'typescript',
                    code: `// ‚ùå BAD - Inline event handler
<div onClick={() => alert('Hello!')}>Click me</div>

// ‚úÖ GOOD - Proper React event handler
const handleClick = () => {
  alert('Hello!')
}

<div onClick={handleClick}>Click me</div>`
                },
                'php-laravel': {
                    file: 'view.blade.php',
                    language: 'html',
                    code: `{{-- ‚ùå BAD - Inline JavaScript --}}
<button onclick="alert('Hello!')">Click me</button>

{{-- ‚úÖ GOOD - External JavaScript --}}
<button id="myButton">Click me</button>

<script>
document.getElementById('myButton').addEventListener('click', function() {
    alert('Hello!');
});
</script>`
                },
                'python-django': {
                    file: 'template.html',
                    language: 'html',
                    code: `{# ‚ùå BAD - Inline event handler #}
<button onclick="alert('Hello!')">Click me</button>

{# ‚úÖ GOOD - Django way #}
<button data-action="click->controller#handleClick">Click me</button>

{# Or use proper event listeners in JavaScript #}
<script>
document.addEventListener('DOMContentLoaded', function() {
    document.querySelector('[data-action]').addEventListener('click', function() {
        alert('Hello!');
    });
});
</script>`
                },
                'java-spring': {
                    file: 'template.html',
                    language: 'html',
                    code: `<!-- ‚ùå BAD - Inline event handler -->
<button onclick="alert('Hello!')">Click me</button>

<!-- ‚úÖ GOOD - Thymeleaf way -->
<button th:onclick="'javascript:alert(\\'Hello!\\')'">Click me</button>

<!-- Even better: Use proper event listeners -->
<button id="myButton">Click me</button>

<script>
document.getElementById('myButton').addEventListener('click', function() {
    alert('Hello!');
});
</script>`
                },
                'static-nginx': {
                    file: 'index.html',
                    language: 'html',
                    code: `<!-- ‚ùå BAD - Inline event handler -->
<button onclick="alert('Hello!')">Click me</button>

<!-- ‚úÖ GOOD - External JavaScript -->
<button id="myButton">Click me</button>

<script src="script.js"></script>

<!-- script.js -->
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('myButton').addEventListener('click', function() {
        alert('Hello!');
    });
});`
                }
            }
        };

        // TECH STACKS MATRIX - Client-side version for the HTML tool
        const TECH_STACKS_MATRIX = {
            'nextjs-vercel': {
                name: 'Next.js / Vercel / React',
                patterns: ['next.js', 'vercel', 'react', 'next.config.js', 'middleware.ts', 'app router'],
                weight: 3
            },
            'php-laravel': {
                name: 'PHP / Laravel / Apache',
                patterns: ['php', 'laravel', 'apache', 'composer', 'blade', '.htaccess'],
                weight: 3
            },
            'python-django': {
                name: 'Python / Django / Flask',
                patterns: ['python', 'django', 'flask', 'jinja', 'settings.py', 'wsgi'],
                weight: 3
            },
            'java-spring': {
                name: 'Java / Spring Boot / Tomcat',
                patterns: ['java', 'spring', 'tomcat', 'jsp', 'thymeleaf', 'websecurityconfig'],
                weight: 3
            },
            'static-nginx': {
                name: 'Static HTML / Nginx',
                patterns: ['nginx', 'static html', 'apache', 'html', 'javascript:', 'onclick='],
                weight: 1
            }
        };

        // Universal mappings for all stacks
        const UNIVERSAL_MAPPINGS = {
            dns: {
                actionType: 'EXTERNAL_ACTION',
                locations: 'DNS Provider Console (Cloudflare, GoDaddy, AWS Route53)',
                context: 'Add DNS records through your DNS provider dashboard. Test with tools like MX Toolbox or DNS Checker.'
            },
            dependencies: {
                actionType: 'CODE_REFACTOR',
                locations: 'package.json, composer.json, requirements.txt, pom.xml',
                context: 'Update vulnerable dependencies using package managers. Run security audits regularly.'
            },
            gitExposure: {
                actionType: 'CONFIG_CHANGE',
                locations: '.git folder, .gitignore, nginx.conf',
                context: 'Delete .git folder from production or configure server to block .git access. Add .git to .gitignore.'
            }
        };

        function clearInput() {
            document.getElementById('inputReport').value = '';
            document.getElementById('outputArea').innerHTML = '<div style="text-align: center; color: #484f58; margin-top: 50px;">Waiting for input data...</div>';
            document.getElementById('stats').innerText = '0 prompts';
        }

        function getContextForVulnerability(vulnType, vulnTitle, techStack) {
            const stackConfig = TECH_STACKS_MATRIX[techStack];

            // SSL/TLS Category
            if (vulnType.includes('SSL') || vulnType.includes('TLS') || vulnTitle.includes('Mixed Content')) {
                return {
                    actionType: 'CONFIG_CHANGE',
                    locations: stackConfig.configFiles,
                    context: vulnTitle.includes('Mixed Content')
                        ? `Search for http:// URLs in HTML templates and replace with https://. Check ${stackConfig.images?.locations || 'static files'} for external resources.`
                        : `Configure HTTPS redirects in ${stackConfig.configFiles}.`
                };
            }

            // Security Headers Category
            if (vulnType.includes('INSECURE_HEADERS') || vulnTitle.includes('Content-Security-Policy') || vulnTitle.includes('HSTS') || vulnTitle.includes('X-Frame-Options')) {
                return {
                    actionType: 'CONFIG_CHANGE',
                    locations: stackConfig.headers.locations,
                    context: stackConfig.headers.context
                };
            }

            // DNS Category
            if (vulnType.includes('DNS') || vulnTitle.includes('SPF') || vulnTitle.includes('DMARC') || vulnTitle.includes('DKIM')) {
                return {
                    actionType: 'EXTERNAL_ACTION',
                    locations: UNIVERSAL_MAPPINGS.dns.locations,
                    context: UNIVERSAL_MAPPINGS.dns.context
                };
            }

            // Performance Category
            if (vulnType.includes('PERFORMANCE') || vulnTitle.includes('Gzip') || vulnTitle.includes('compression') || vulnTitle.includes('Cache')) {
                if (vulnTitle.includes('Gzip') || vulnTitle.includes('compression')) {
                    return {
                        actionType: 'CONFIG_CHANGE',
                        locations: stackConfig.compression.locations,
                        context: stackConfig.compression.context
                    };
                }
                if (vulnTitle.includes('Cache')) {
                    return {
                        actionType: 'CONFIG_CHANGE',
                        locations: stackConfig.caching.locations,
                        context: stackConfig.caching.context
                    };
                }
            }

            // XSS Category
            if (vulnType.includes('XSS') || vulnTitle.includes('inline event handler') || vulnTitle.includes('javascript:')) {
                return {
                    actionType: 'CODE_REFACTOR',
                    locations: stackConfig.xssCode.locations,
                    context: stackConfig.xssCode.context
                };
            }

            // Information Disclosure
            if (vulnType.includes('INFORMATION_DISCLOSURE') || vulnTitle.includes('Server header')) {
                if (vulnTitle.includes('Server header')) {
                    return {
                        actionType: 'CONFIG_CHANGE',
                        locations: stackConfig.serverInfo.locations,
                        context: stackConfig.serverInfo.context
                    };
                }
            }

            // Misc Configuration
            if (vulnType.includes('MISCONFIGURATION') || vulnTitle.includes('CORS')) {
                if (vulnTitle.includes('CORS')) {
                    return {
                        actionType: 'CONFIG_CHANGE',
                        locations: stackConfig.cors.locations,
                        context: stackConfig.cors.context
                    };
                }
            }

            // Default fallback
            return {
                actionType: 'CONFIG_CHANGE',
                locations: stackConfig.configFiles,
                context: `Review the vulnerability details and determine appropriate configuration changes for ${stackConfig.name}.`
            };
        }

        // Auto-detect technology stack from report content
        function autoDetectStack(reportText) {
            const text = reportText.toLowerCase();

            // Calculate scores for each stack
            const scores = Object.entries(TECH_STACKS_MATRIX).map(([stackKey, stackConfig]) => {
                let score = 0;
                stackConfig.patterns.forEach(pattern => {
                    const regex = new RegExp(pattern.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
                    const matches = text.match(regex);
                    if (matches) {
                        score += matches.length * stackConfig.weight;
                    }
                });
                return { stack: stackKey, score, name: stackConfig.name };
            });

            // Return stack with highest score
            const bestMatch = scores.reduce((best, current) =>
                current.score > best.score ? current : best
            );

            return bestMatch.score > 0 ? bestMatch : { stack: 'nextjs-vercel', name: 'Next.js / Vercel / React', score: 0 };
        }

        function generatePrompts() {
            const text = document.getElementById('inputReport').value;
            const outputArea = document.getElementById('outputArea');
            const selectedStack = document.getElementById('techStack').value;
            outputArea.innerHTML = '';

            if (!text.trim()) {
                alert('Please paste the report content first.');
                return;
            }

            // Auto-detect stack from report content
            const detectedStack = autoDetectStack(text);
            const techStack = detectedStack.score > 0 ? detectedStack.stack : selectedStack;

            console.log('Detected stack:', detectedStack, 'Using stack:', techStack);

            // Parse vulnerabilities using regex
            const vulnBlocks = text.split(/(?=### \d+\.)/g);
            let count = 0;

            vulnBlocks.forEach(block => {
                const titleMatch = block.match(/### \d+\. (.+?)(?=\n\n|\n\*\*Type:)/s);
                const typeMatch = block.match(/\*\*Type:\*\* (.+?)(?=\n|$)/);
                const severityMatch = block.match(/\*\*Severity:\*\* (.+?)(?=\n|$)/);
                const descMatch = block.match(/\*\*Description:\*\*\n(.+?)(?=\n\n\*\*Recommendation:)/s);
                const recMatch = block.match(/\*\*Recommendation:\*\*\n(.+?)(?=\n\n|$)/s);

                if (titleMatch && descMatch && recMatch) {
                    count++;
                    const title = titleMatch[1].trim();
                    const type = typeMatch ? typeMatch[1].trim() : 'General';
                    const severity = severityMatch ? severityMatch[1].trim() : 'Medium';
                    const desc = descMatch[1].trim();
                    const rec = recMatch[1].trim();

                    // Get context based on tech stack
                    const context = getContextForVulnerability(type, title, techStack);

                    // Get code scaffolding if available
                    let scaffoldingText = '';
                    const snippetKey = title.toLowerCase().includes('content-security-policy') ? 'Content-Security-Policy' :
                                     title.toLowerCase().includes('x-frame-options') ? 'X-Frame-Options' :
                                     type === 'XSS' || title.toLowerCase().includes('inline') ? 'Inline Event Handlers' : null;

                    if (snippetKey && SNIPPET_DATABASE[snippetKey] && SNIPPET_DATABASE[snippetKey][techStack]) {
                        const snippet = SNIPPET_DATABASE[snippetKey][techStack];
                        scaffoldingText = `

**FIX IMPLEMENTATION (CODE SCAFFOLDING):**
Here is the exact code pattern you should apply. Integrate this into the file ${snippet.file}.

\`\`\`${snippet.language}
${snippet.code}
\`\`\`

**Integration Instructions:**
1. Locate the file: ${snippet.file}
2. Add or modify the configuration as shown in the scaffolding above
3. Ensure proper syntax and indentation
4. Test the configuration after applying`;
                    }

                    // Determine severity class
                    let cssClass = 'med';
                    if (severity === 'CRITICAL' || severity === 'HIGH') {
                        cssClass = 'high';
                    }

                    // Generate full AI prompt
                    const fullPrompt = `Act as a Senior Security Engineer and an Expert Frontend/Backend Developer.

I have run a security audit and identified the following issue in the codebase:

**ISSUE TITLE:** ${title}
**SEVERITY:** ${severity}
**TYPE:** ${type}

**DESCRIPTION:**
${desc}

**RECOMMENDATION:**
${rec}

**YOUR TASK:**
1. Analyze the relevant files in the current workspace to locate where this issue exists.
2. Implement the necessary code or configuration changes to fix this vulnerability according to the recommendation.
3. Ensure the fix follows best security practices (OWASP).
4. Explain briefly what you changed and why.${scaffoldingText}

**SPECIFIC CONTEXT:**
${context.context}

**LIKELY FILE LOCATIONS:**
${context.locations}

**ACTION TYPE REQUIRED:**
${context.actionType}

**Constraints:**
- Do not ask me for permission, just fix it.
- If the issue is in a config file (like vercel.json, next.config.js, headers), modify it directly.
- Be precise and provide working code examples.
- Test the changes to ensure they work correctly.

**URL:** [INSERT_TARGET_URL]
**DOMAIN:** [INSERT_DOMAIN]`;

                    // Create HTML card
                    const card = document.createElement('div');
                    card.className = `prompt-card ${cssClass}`;

                    const stackInfo = detectedStack.score > 0
                        ? `üîç Auto-detected: ${detectedStack.name} (${detectedStack.score > 3 ? 'High' : 'Medium'} confidence)`
                        : `üìã Manual selection: ${TECH_STACKS_MATRIX[techStack].name}`;

                    card.innerHTML = `
                        <div class="card-header">
                            <span>${title}</span>
                            <span class="badge ${cssClass}">${severity}</span>
                        </div>
                        <div class="card-header" style="margin-bottom: 10px;">
                            <span>Action: ${context.actionType}</span>
                            <span style="color: #58a6ff; font-size: 0.75rem;">${stackInfo}</span>
                        </div>
                        <div class="prompt-content">${fullPrompt}</div>
                        <button class="btn" onclick="copyToClipboard(this)">üìã Copy Prompt for Agent</button>
                    `;
                    outputArea.appendChild(card);
                }
            });

            const stackDisplayName = TECH_STACKS_MATRIX[techStack].name;
            const detectionNote = detectedStack.score > 0 ? ' (Auto-detected)' : ' (Manual selection)';
            document.getElementById('stats').innerText = `${count} prompts generated for ${stackDisplayName}${detectionNote}`;
        }

        function copyToClipboard(btnElement) {
            const promptText = btnElement.parentElement.querySelector('.prompt-content').innerText;

            navigator.clipboard.writeText(promptText).then(() => {
                const originalText = btnElement.innerText;
                btnElement.innerText = '‚úÖ Copied!';
                btnElement.style.background = '#238636';

                setTimeout(() => {
                    btnElement.innerText = originalText;
                    btnElement.style.background = '';
                }, 2000);
            });
        }
    </script>
</body>
</html>